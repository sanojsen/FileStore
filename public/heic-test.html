<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEIC Thumbnail Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-area {
            border: 2px dashed #ccc;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .thumbnail {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            margin: 10px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>üß™ HEIC Thumbnail Test</h1>
    <p>This page tests HEIC thumbnail generation without the complexity of the full upload system.</p>
    
    <div class="test-area">
        <h3>üìÅ Select HEIC File</h3>
        <input type="file" id="fileInput" accept=".heic,.heif,image/heic,image/heif" />
        <button onclick="testHEIC()">Test HEIC Conversion</button>
        <button onclick="testLibraryLoad()">Test Library Load</button>
        <button onclick="runDiagnostic()">Run Full Diagnostic</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div id="status" class="status info">Ready to test HEIC conversion</div>
    
    <div class="test-area">
        <h3>üñºÔ∏è Generated Thumbnail</h3>
        <div id="thumbnailContainer"></div>
    </div>

    <div class="test-area">
        <h3>üìã Console Log</h3>
        <div id="log" class="log"></div>
    </div>

    <script src="/heic-diagnostic.js"></script>
    <script type="module">
        // Override console.log to capture output
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToLog(level, ...args) {
            const logDiv = document.getElementById('log');
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = level === 'error' ? '#dc3545' : level === 'warn' ? '#f57c00' : '#000';
            logEntry.textContent = `[${time}] ${level.toUpperCase()}: ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Also call original console function
            if (level === 'error') originalError(...args);
            else if (level === 'warn') originalWarn(...args);
            else originalLog(...args);
        }
        
        console.log = (...args) => addToLog('info', ...args);
        console.error = (...args) => addToLog('error', ...args);
        console.warn = (...args) => addToLog('warn', ...args);

        // Test functions
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };

        window.setStatus = function(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        };

        window.runDiagnostic = async function() {
            setStatus('Running full diagnostic...', 'info');
            await window.HEICDiagnostic.runFullDiagnostic();
            setStatus('Diagnostic completed - check console log', 'success');
        };

        window.testLibraryLoad = async function() {
            setStatus('Testing heic2any library load...', 'info');
            console.log('üß™ Testing heic2any library load');
            
            try {
                const module = await import('heic2any');
                const heic2any = module.default || module;
                
                console.log('‚úÖ heic2any module loaded:', typeof heic2any);
                
                if (typeof heic2any === 'function') {
                    setStatus('‚úÖ heic2any library loaded successfully', 'success');
                    console.log('‚úÖ heic2any is ready to use');
                } else {
                    setStatus('‚ùå heic2any is not a function', 'error');
                    console.error('‚ùå heic2any is not a function, got:', typeof heic2any);
                }
            } catch (error) {
                setStatus(`‚ùå Failed to load heic2any: ${error.message}`, 'error');
                console.error('‚ùå Failed to load heic2any:', error);
            }
        };

        window.testHEIC = async function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                setStatus('Please select a HEIC file first', 'error');
                return;
            }
            
            setStatus(`Testing HEIC conversion for: ${file.name}`, 'info');
            console.log('üß™ Testing HEIC conversion for:', file.name);
            console.log('üìä File info:', {
                name: file.name,
                type: file.type,
                size: file.size,
                sizeKB: Math.round(file.size / 1024),
                sizeMB: Math.round(file.size / 1024 / 1024 * 10) / 10
            });
            
            try {
                // Test library load first
                console.log('üì¶ Loading heic2any library...');
                const module = await import('heic2any');
                const heic2any = module.default || module;
                
                if (typeof heic2any !== 'function') {
                    throw new Error('heic2any is not a function');
                }
                
                console.log('‚úÖ heic2any loaded successfully');
                setStatus('Converting HEIC to JPEG...', 'info');
                
                // Convert HEIC to JPEG
                const startTime = Date.now();
                const jpegBlob = await heic2any({
                    blob: file,
                    toType: 'image/jpeg',
                    quality: 0.8
                });
                const conversionTime = Date.now() - startTime;
                
                console.log('‚úÖ HEIC conversion successful!');
                console.log('üìä Conversion stats:', {
                    originalSize: file.size,
                    convertedSize: jpegBlob.size,
                    compressionRatio: Math.round((1 - jpegBlob.size / file.size) * 100),
                    conversionTime: conversionTime
                });
                
                // Create thumbnail from converted image
                setStatus('Creating thumbnail from converted image...', 'info');
                const thumbnail = await createThumbnailFromBlob(jpegBlob, 300);
                
                if (thumbnail) {
                    console.log('‚úÖ Thumbnail created successfully');
                    displayThumbnail(thumbnail);
                    setStatus('‚úÖ HEIC conversion and thumbnail creation successful!', 'success');
                } else {
                    throw new Error('Failed to create thumbnail from converted image');
                }
                
            } catch (error) {
                console.error('‚ùå HEIC test failed:', error);
                setStatus(`‚ùå HEIC test failed: ${error.message}`, 'error');
            }
        };

        // Helper function to create thumbnail from blob
        async function createThumbnailFromBlob(blob, maxSize) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                img.onload = () => {
                    try {
                        // Calculate dimensions
                        const aspectRatio = img.width / img.height;
                        let width, height;

                        if (aspectRatio > 1) {
                            width = Math.min(maxSize, img.width);
                            height = Math.round(width / aspectRatio);
                        } else {
                            height = Math.min(maxSize, img.height);
                            width = Math.round(height * aspectRatio);
                        }

                        canvas.width = width;
                        canvas.height = height;

                        // Draw image
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to blob
                        canvas.toBlob((thumbnailBlob) => {
                            if (thumbnailBlob) {
                                resolve({
                                    blob: thumbnailBlob,
                                    width: width,
                                    height: height,
                                    url: URL.createObjectURL(thumbnailBlob)
                                });
                            } else {
                                reject(new Error('Failed to create thumbnail blob'));
                            }
                        }, 'image/jpeg', 0.85);
                    } catch (error) {
                        reject(error);
                    }
                };

                img.onerror = () => reject(new Error('Failed to load converted image'));
                img.src = URL.createObjectURL(blob);
            });
        }

        // Helper function to display thumbnail
        function displayThumbnail(thumbnail) {
            const container = document.getElementById('thumbnailContainer');
            container.innerHTML = '';
            
            const img = document.createElement('img');
            img.src = thumbnail.url;
            img.className = 'thumbnail';
            img.alt = 'Generated thumbnail';
            
            const info = document.createElement('div');
            info.textContent = `${thumbnail.width}x${thumbnail.height}`;
            
            container.appendChild(img);
            container.appendChild(info);
        }

        // Auto-test library load on page load
        window.addEventListener('load', () => {
            console.log('üåê HEIC Test Page Loaded');
            testLibraryLoad();
        });
    </script>
</body>
</html>
